<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Last Fm</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
</head>
<body>

    <div class="header-container">
        <header class="wrapper clearfix">

            <div class="navbar navbar-inverse">
                <div class="navbar-collapse collapse navbar-inverse-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="MusicBrainz.html">MusicBrainz</a></li>
                        <li class="active"><a href="LastFm.html">Last.fm</a></li>
                        <li><a href="Favourites.html">Favourites</a></li>
                    </ul>

                </div>
            </div>
        </header>
    </div>
    <div class="main-container">
        <div class="main wrapper clearfix">
            <h2>Search Last.fm</h2>
            <br />
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search Artist" name="artistName" id="artistName">
                <div class="input-group-btn">
                    <button class="btn btn-default" id="btnsearch" type="submit"><i class="glyphicon glyphicon-search"></i></button>
                </div>
            </div>
            <br />
            <h2>Search  Results </h2>
            <hr />
            <div id="divinfo" class="alert-danger">
                <label id="lblerror"></label>
            </div>
            <br />
            <div class="well well-sm text-right">
                <a href="ShortList.html"><input type="button" class="btn btn-info btn-default" value="Show short-list"></a>
            </div>
            <br />
            <table class="table table-striped table-hover table-condensed" id="artistTbl">
                <thead>
                    <tr>
                        <th></th><!--column for generating small images of artists-->
                        <th>Artist Name</th>
                        <th></th> <!--column for generating add favourites-->

                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="divTotal" class="alert-info">
                <label id="lblTotal"></label>
            </div>
        </div> <!-- #main -->
    </div> <!-- #main-container -->
    <div class="footer-container">
        <footer class="wrapper">
            Caroline Chirenje Assesment
        </footer>
    </div>


    <script src="Scripts/jquery-2.1.3.min.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            userName = ''; //clear name
            $('#divinfo').hide(); // by default this is not seen by the user
            $('#divTotal').hide();
            $('.addFav').click(function (element) {//gets the specific id of the artist row clicked
                var clickedArtist = $(this).attr('id');
                console.log("Clicked artist is " + clickedArtist);
                if (clickedArtist != "undefined") {
                    addToFavourites(clickedArtist);
                }
            });

            $('#btnsearch').click(function () {
                $('#divinfo').hide();
                userName = $('#artistName').val();
                if (userName != '') { // no need to go and fetch data if no name has been provided
                    console.log(userName);
                    getArtistInfo(userName)
                   .error(function (req, status, errorObj) {
                       $('#divinfo').show();
                       $("#lblerror").text("Some error occured whilst retrieving data");
                   })
                   .done(function (data) {
                       extractData(data);//extract data returned from ajax call

                   });
                }
                else {
                    $('#divinfo').show();
                    $("#lblerror").text("Please provide artist name");
                }

            });

        });

        function getArtistInfo(userName) {
            var url = 'http://ws.audioscrobbler.com/2.0/?method=artist.search&artist=' + userName + '&api_key=759eaf51b7b1b678e7616ef6a95d1ba5&format=json';
            console.log("Url is " + url);
            return $.ajax({
                type: "GET",
                url: url,
                data: '{}',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                async: true
            });
        } //gets artist info through an ajax call

        function extractData(response) {
            var objectlength = isEmpty(response);
            console.log("Response is empty : " + objectlength);
            if (!objectlength) {
                var resultsLength = response.results.artistmatches.artist.length
                console.log(resultsLength + " returned.");
                if (resultsLength > 0) {
                    //save the data to local storage
                    saveData(response);
                    showResults(response, resultsLength);
                }
                else {
                    $('#divinfo').show();
                    $("#lblerror").text("No results returned by search.");
                }

            }
        }

        function isEmpty(response) {
            return Object.keys(response).length === 0;
        }

        function showResults(results, resultsLength) {
            console.dir(results);
            //loop through and retrieve the desired artist data
            for (i = 0; i < resultsLength; i++) {
                currentArtist = results.results.artistmatches.artist[i];
                var Id = currentArtist.name;
                $('#artistTbl').append('<tr><td> <img src="' + currentArtist.image["0"]["#text"] + '"/></td><td>' + currentArtist.name + '</td><td>' + '<a href="#" class="addFav" id= "' + Id + '"><span class="glyphicon glyphicon-plus-sign" style="color:green"></span></a>' + '</td></tr>');
            }
            console.log("Finished loading artists");
            $("#lblTotal").text("Total Results :" + resultsLength);
            $('#divTotal').show();
        }

        function saveData(results) {
            // Put the results into storage
            localStorage.setItem('artistResults', JSON.stringify(results));
            console.log("Saved to local storage");
        };

        function addToFavourites(clickedArtist) {
            if (clickedArtist == undefined)
            { return; } // no need to save meaningless data
            // Parse any JSON previously stored in Favourites
            var existingEntries = JSON.parse(localStorage.getItem("Favourites"));
            if (existingEntries == null) existingEntries = [];
            var favouriteArtist = {
                "Artistname": clickedArtist

            };
            localStorage.setItem("entry", JSON.stringify(favouriteArtist));
            // Save allEntries back to local storage
            existingEntries.push(favouriteArtist);
            localStorage.setItem("Favourites", JSON.stringify(existingEntries));
            console.log(clickedArtist + " added to favourites");
        }
    </script>
</body>
</html>
